<section class="hero">
  <div class="hero__inner">
    <button class="hero__control left" type="button" (click)="prevSlide()" aria-label="Anterior">
      <mat-icon>chevron_left</mat-icon>
    </button>

    <article
      class="hero__slide"
      *ngFor="let slide of slides; let idx = index"
      [class.is-active]="idx === slideIndex"
      [attr.data-theme]="slide.theme"
    >
      <div class="hero__content">
        <p class="eyebrow">Colección destacada</p>
        <h1>{{ slide.title }}</h1>
        <p class="copy">{{ slide.caption }}</p>
        <button mat-flat-button color="primary" (click)="onHeroCta()">
          {{ slide.cta }}
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
      <div class="hero__visual" aria-hidden="true"></div>
    </article>

    <button class="hero__control right" type="button" (click)="nextSlide()" aria-label="Siguiente">
      <mat-icon>chevron_right</mat-icon>
    </button>

    <div class="hero__dots" role="tablist" aria-label="Slides destacados">
      <button
        *ngFor="let slide of slides; let idx = index"
        type="button"
        [class.is-active]="idx === slideIndex"
        (click)="slideIndex = idx"
        [attr.aria-label]="'Ir al slide ' + (idx + 1)"
      ></button>
    </div>
  </div>
</section>

<section class="novedades-section">
  <div class="section-header">
    <div>
      <p class="eyebrow">Lo más reciente</p>
      <h2>Novedades seleccionadas</h2>
    </div>
    <a mat-stroked-button color="primary" routerLink="/novedades">
      Ver todas
      <mat-icon>chevron_right</mat-icon>
    </a>
  </div>

  <div class="novedades-grid" *ngIf="!loadingNovedades && novedades.length; else novedadesFallback">
    <mat-card class="novedad-card" *ngFor="let producto of novedades" appearance="outlined">
      <div class="thumb">
        <button type="button" (click)="verDetalle(producto)">
          <img
            *ngIf="producto.imagenBase64; else novedadNoImg"
            [src]="'data:image/png;base64,' + producto.imagenBase64"
            [alt]="producto.nombrePublico || 'Producto'"
            loading="lazy"
          />
        </button>
        <ng-template #novedadNoImg>
          <span class="thumb-fallback">
            <mat-icon>image</mat-icon>
          </span>
        </ng-template>
      </div>
      <mat-card-content>
        <div class="meta-row">
          <span class="badge">Nuevo</span>
          <span class="cat">{{ getPrimaryCategoria(producto) || 'General' }}</span>
        </div>
        <button type="button" class="title" (click)="verDetalle(producto)">
          {{ producto.nombrePublico || 'Producto' }}
        </button>
        <div class="price">
          {{ producto.precio | currency:'CLP':'symbol-narrow':'1.0-0' }}
        </div>
        <div class="actions">
          <button
            mat-flat-button
            color="primary"
            (click)="agregar(producto)"
            [disabled]="producto.stock <= 0"
          >
            <mat-icon>add_shopping_cart</mat-icon>
            {{ producto.stock > 0 ? 'Agregar al carro' : 'Sin stock' }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <ng-template #novedadesFallback>
    <div class="novedades-empty" *ngIf="!loadingNovedades">No hay novedades disponibles por ahora.</div>
    <div class="novedades-skeleton" *ngIf="loadingNovedades">
      <div class="skeleton-card" *ngFor="let _ of [].constructor(4)">
        <div class="sk-img shimmer"></div>
        <div class="sk-line shimmer"></div>
        <div class="sk-line short shimmer"></div>
      </div>
    </div>
  </ng-template>
</section>

<section class="catalogo-section">
  <div class="section-header">
    <div>
      <p class="eyebrow">Catálogo</p>
      <h2>Todos los productos</h2>
      <p class="filters" *ngIf="searchText || categoriaSeleccionadaNombre">
        <span *ngIf="searchText">Buscando «{{ searchText }}»</span>
        <span *ngIf="categoriaSeleccionadaNombre"> · Categoría: {{ categoriaSeleccionadaNombre }}</span>
      </p>
    </div>
  </div>

  <div class="catalogo-grid" *ngIf="!loadingProductos && productos.length; else catalogoFallback">
    <mat-card class="producto-card" *ngFor="let p of productos" appearance="outlined">
      <div class="image-wrap">
        <button type="button" class="image-btn" (click)="verDetalle(p)">
          <img
            *ngIf="p.imagenBase64; else noImg"
            [src]="'data:image/png;base64,' + p.imagenBase64"
            [alt]="p.nombrePublico || 'Producto'"
            loading="lazy"
          />
        </button>
        <ng-template #noImg>
          <button type="button" class="image-btn" (click)="verDetalle(p)">
            <div class="img-fallback">
              <mat-icon>image</mat-icon>
            </div>
          </button>
        </ng-template>

        <span class="badge" *ngIf="p.destacado">Destacado</span>
        <span class="badge neutral" *ngIf="p.novedad">Nuevo</span>
        <span class="badge danger" *ngIf="p.stock <= 0">Sin stock</span>
      </div>

      <mat-card-content class="content">
        <button type="button" class="title" (click)="verDetalle(p)" [matTooltip]="p.nombrePublico || 'Producto'">
          {{ p.nombrePublico || 'Producto' }}
        </button>

        <div class="meta">
          <span class="cat">{{ getPrimaryCategoria(p) || '—' }}</span>
        </div>

        <div class="price">
          {{ p.precio | currency:'CLP':'symbol-narrow':'1.0-0' }}
        </div>

        <div class="actions">
          <button
            mat-flat-button
            color="primary"
            (click)="agregar(p)"
            [disabled]="p.stock <= 0"
          >
            <mat-icon>add_shopping_cart</mat-icon>
            {{ p.stock > 0 ? 'Agregar' : 'Sin stock' }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <ng-template #catalogoFallback>
    <div class="catalogo-empty" *ngIf="!loadingProductos">No encontramos productos que coincidan con tu búsqueda.</div>
    <div class="catalogo-skeleton" *ngIf="loadingProductos">
      <div class="skeleton-card" *ngFor="let _ of [].constructor(page.pageSize)">
        <div class="sk-img shimmer"></div>
        <div class="sk-line shimmer"></div>
        <div class="sk-line short shimmer"></div>
        <div class="sk-btn shimmer"></div>
      </div>
    </div>
  </ng-template>

  <div class="paginator-row" *ngIf="page.totalElements > page.pageSize">
    <mat-paginator
      [length]="page.totalElements"
      [pageIndex]="page.pageNumber"
      [pageSize]="page.pageSize"
      [pageSizeOptions]="[8, 12, 16, 24]"
      (page)="onPageChange($event)"
    ></mat-paginator>
  </div>
</section>
